<!DOCTYPE html>
<html>
  <head>
    <title>direct upload s3</title>
  </head>
  <body>
    <input type="file" id="file-input" />
    <p id="status">
      Please select a file.
    </p>
    <form method="post" action="save-details">
      <input type="hidden" id="avatar-url" name="avatar-url" value="/images/default.png" />
      <input type="text" name="username" placeholder="User Name" /><br/>
      <input type="text" name="full-name" placeholder="Full Name"  /><br/>
      <input type="submit" value="Update" />
    </form>
    <script type="text/javascript">
      function uploadFile(file,signedRequest,url){
        const xhr=new XMLHttpRequest();
        xhr.open('PUT',signedRequest);
        xhr.onreadystatechange=()=>{
          if(xhr.readyState===4){
            if(xhr.status===200){
              document.getElementById('preview').src=url;
              document.getElementById('avatar-url').value=url;
            }else{
              alert('could not upload file');
            }
          }
        };
        xhr.send(file);
      }
      function getSignedRequest(file){
        const xhr=new XMLHttpRequest();
        xhr.open('GET','/sign-s3?file-name=${file.name}&file-type=${file.type}');
        xhr.onreadystatechange()=>{
          if(xhr.readyState===4){
            if(xhr.status===200){
              const response=JSON.parse(xhr.responseText);
              uploadFile(file,response.signedRequest,response.url);
            }else{
              alert('could not get signed URL.....');
            }
          }
        }
        xhr.send();
      }
      function initUpload(){
        const file=document.getElementById('file-input').files;
        const file=files[0];
        if(file==null){
          return alert('no file selected');
        }
        getSignedRequest(file);
      }
      (()=>{
        document.getElementById('file-input').onchange=initUpload;
      })();
    </script>
  </body>
</html>
